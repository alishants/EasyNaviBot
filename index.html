from telegram import Update
from telegram.ext import Application, MessageHandler, filters, ContextTypes
import googlemaps

# Вставь свои ключи
TELEGRAM_TOKEN = "YOUR_TELEGRAM_BOT_TOKEN"
GOOGLE_MAPS_API_KEY = "YOUR_GOOGLE_MAPS_API_KEY"

# Инициализация Google Maps API
gmaps = googlemaps.Client(key=GOOGLE_MAPS_API_KEY)

# Приветственное сообщение
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    welcome_message = (
        "Привет! Я навигационный бот. Напиши мне адрес, название места или услугу, и я помогу тебе! \U0001F30D"
    )
    await update.message.reply_text(welcome_message)

# Логика поиска
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_message = update.message.text.strip()

    try:
        geocode_result = gmaps.geocode(user_message)
        
        if geocode_result:
            location = geocode_result[0]["geometry"]["location"]
            formatted_address = geocode_result[0]["formatted_address"]
            google_maps_url = f"https://www.google.com/maps/dir/?api=1&destination={location['lat']},{location['lng']}"
            response = f"\U0001F4CD Адрес: {formatted_address}\n\U0001F6E3 Маршрут: {google_maps_url}"

        elif any(keyword in user_message.lower() for keyword in ["метро", "станция"]):
            places_result = gmaps.places(query=user_message, type="subway_station")
            if places_result.get("results"):
                station = places_result["results"][0]
                name = station.get("name", "Неизвестная станция")
                location = station["geometry"]["location"]
                google_maps_url = f"https://www.google.com/maps?q={location['lat']},{location['lng']}"
                response = f"\U0001F689 Станция метро: {name}\n\U0001F6A9 Карта: {google_maps_url}"
            else:
                response = "Не удалось найти станцию метро по вашему запросу."

        elif gmaps.places(query=user_message, type="route").get("results"):
            # Если запрос - улица
            route_result = gmaps.places(query=user_message, type="route")["results"][0]
            name = route_result.get("name", "Неизвестная улица")
            google_maps_url = f"https://www.google.com/maps?q={name}"
            response = f"\U0001F6A7 Улица: {name}\n\U0001F5FA Карта: {google_maps_url}"

        elif user_message.lower() in ["кафе", "рестораны", "магазины", "сигареты"]:
            # Если ищут категории мест
            places_result = gmaps.places_nearby(
                location=(41.3851, 2.1734), radius=5000, keyword=user_message
            )
            if places_result.get("results"):
                suggestions = "\n".join(
                    [
                        f"\U0001F4CC {place.get('name', 'Неизвестное место')} - {place.get('vicinity', 'Адрес не найден')}"
                        for place in places_result["results"][:5]
                    ]
                )
                response = f"Вот что я нашел поблизости:\n{suggestions}"
            else:
                response = "Не удалось найти подходящие места поблизости."

        else:
            # Поиск любых других мест
            places_result = gmaps.places(query=user_message)
            if places_result.get("results"):
                place = places_result["results"][0]
                name = place.get("name", "Неизвестное место")
                address = place.get("formatted_address", "Адрес не найден")
                location = place["geometry"]["location"]
                google_maps_url = f"https://www.google.com/maps?q={location['lat']},{location['lng']}"
                response = f"\U0001F4CC Место: {name}\n\U0001F4CD Адрес: {address}\n\U0001F5FA Карта: {google_maps_url}"
            else:
                response = "Не удалось найти места по вашему запросу."

        await update.message.reply_text(response)

    except Exception as e:
        await update.message.reply_text(f"Произошла ошибка: {e}")

# Основная функция запуска
def main():
    application = Application.builder().token(TELEGRAM_TOKEN).build()
    application.add_handler(MessageHandler(filters.COMMAND, start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.run_polling()

if __name__ == "__main__":
    main()
